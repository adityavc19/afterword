import { useState, useEffect, useRef } from "react";

// --- Constants & Data ---
const MOCK_BOOKS = [
  { id: 1, title: "Never Let Me Go", author: "Kazuo Ishiguro", year: 2005, genre: "Literary Fiction", pages: 288, rating: 3.83, ratings: "542,891", cover: null },
  { id: 2, title: "Normal People", author: "Sally Rooney", year: 2018, genre: "Contemporary Fiction", pages: 273, rating: 4.01, ratings: "892,341", cover: null },
  { id: 3, title: "Educated", author: "Tara Westover", year: 2018, genre: "Memoir", pages: 334, rating: 4.47, ratings: "1,203,445", cover: null },
  { id: 4, title: "Sapiens", author: "Yuval Noah Harari", year: 2011, genre: "Non-Fiction", pages: 443, rating: 4.36, ratings: "987,234", cover: null },
  { id: 5, title: "Project Hail Mary", author: "Andy Weir", year: 2021, genre: "Science Fiction", pages: 476, rating: 4.52, ratings: "756,892", cover: null },
];

const SELECTED_BOOK = MOCK_BOOKS[0]; // Never Let Me Go

const LOADING_STEPS = [
  { label: "Fetching book details", duration: 800 },
  { label: "Reading Goodreads reviews", duration: 2200 },
  { label: "Scanning Reddit discussions", duration: 1800 },
  { label: "Loading critical reviews", duration: 1500 },
  { label: "Searching for author interviews", duration: 1200 },
];

const AMBIENT_QUOTE = `"What is so chilling about this novel is how it demonstrates the capacity of human beings to live with what is monstrous, and their ability to put off thinking about it."`;
const AMBIENT_QUOTE_SOURCE = "— The Guardian";

const BOOK_DETAIL = {
  synopsis: "As children, Kathy, Ruth, and Tommy were students at Hailsham, an exclusive boarding school in the English countryside. It was a place of mercurial cliques and mysterious rules where teachers were known as guardians. Now Kathy is thirty-one, and she's been a carer for over eleven years.",
  critics: "Widely regarded as Ishiguro's most emotionally devastating work — a quiet masterpiece that uses its speculative premise to interrogate what it means to be fully human.",
  readers: "Polarising pace: readers who connect with the restrained narration find it haunting; those who don't find it frustratingly passive. The ending lands hard for nearly everyone.",
  debate: "Is Kathy a reliable narrator or someone in deep denial? Does the allegorical reading (we are all Hailsham students) enrich or flatten the story?",
};

const MOCK_MESSAGES = [];

const QUESTION_PROMPTS = [
  "Why don't the students ever try to escape?",
  "Is Kathy a reliable narrator or in deep denial?",
  "What's the significance of the Judy Bridgewater tape?",
  "How does this compare to other Ishiguro novels?",
  "Why does the ending hit so hard when you see it coming?",
];

const COMPANION_RESPONSE = {
  content: `That's one of the most haunting aspects of the book — how Ishiguro makes their acceptance feel both alien and deeply recognizable. There's a sharp Paris Review interview where he talks about this directly: he wasn't interested in writing a dystopian escape narrative. He wanted to explore how people accommodate themselves to the unacceptable.\n\nGoodreads readers are genuinely split on this. Some find the passivity infuriating — "Why don't they just run?" comes up in almost every discussion thread. But the readers who connect most deeply tend to recognize something uncomfortably familiar: we all, to varying degrees, accept the terms we're given without questioning them.\n\nWhat's interesting is whether you read Kathy as someone in denial, or someone who has a more complete understanding of her situation than we give her credit for. The way she narrates — those careful qualifications, the things she circles around but never quite says — do you read that as suppression or as a kind of dignity?`,
  sources: ["Paris Review Interview", "Goodreads Reviews", "r/books"],
};

// --- Styles ---
const fonts = `
@import url('https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;1,9..40,300;1,9..40,400&family=JetBrains+Mono:wght@400&display=swap');
`;

// --- App ---
export default function BookCompanionMockup() {
  const [screen, setScreen] = useState("home"); // home, loading, detail
  const [searchQuery, setSearchQuery] = useState("");
  const [showSuggestions, setShowSuggestions] = useState(false);
  const [loadingStep, setLoadingStep] = useState(0);
  const [loadingComplete, setLoadingComplete] = useState(false);
  const [messages, setMessages] = useState(MOCK_MESSAGES);
  const [inputValue, setInputValue] = useState("");
  const [isTyping, setIsTyping] = useState(false);
  const [userHasSent, setUserHasSent] = useState(false);
  const [detailSearchQuery, setDetailSearchQuery] = useState("");
  const [showDetailSuggestions, setShowDetailSuggestions] = useState(false);
  const chatEndRef = useRef(null);
  const [fadeIn, setFadeIn] = useState(false);

  useEffect(() => {
    setFadeIn(false);
    requestAnimationFrame(() => setFadeIn(true));
  }, [screen]);

  // Loading animation
  useEffect(() => {
    if (screen !== "loading") return;
    setLoadingStep(0);
    setLoadingComplete(false);

    let step = 0;
    const advance = () => {
      step++;
      if (step < LOADING_STEPS.length) {
        setLoadingStep(step);
        setTimeout(advance, LOADING_STEPS[step].duration);
      } else {
        setLoadingComplete(true);
        setTimeout(() => setScreen("detail"), 600);
      }
    };
    setTimeout(advance, LOADING_STEPS[0].duration);
  }, [screen]);

  // Auto-scroll chat
  useEffect(() => {
    chatEndRef.current?.scrollIntoView({ behavior: "smooth" });
  }, [messages, isTyping]);

  const handleSelectBook = () => {
    setScreen("loading");
  };

  const handleSendMessage = () => {
    if (!inputValue.trim()) return;
    const userMsg = { role: "user", content: inputValue.trim(), sources: [] };
    setMessages((prev) => [...prev, userMsg]);
    setInputValue("");
    setUserHasSent(true);
    setIsTyping(true);

    // Simulate companion response
    setTimeout(() => {
      setIsTyping(false);
      setMessages((prev) => [
        ...prev,
        { role: "assistant", content: COMPANION_RESPONSE.content, sources: COMPANION_RESPONSE.sources },
      ]);
    }, 2800);
  };

  const filteredBooks = searchQuery.length > 0
    ? MOCK_BOOKS.filter(
        (b) =>
          b.title.toLowerCase().includes(searchQuery.toLowerCase()) ||
          b.author.toLowerCase().includes(searchQuery.toLowerCase())
      )
    : [];

  const detailFilteredBooks = detailSearchQuery.length > 0
    ? MOCK_BOOKS.filter(
        (b) =>
          b.title.toLowerCase().includes(detailSearchQuery.toLowerCase()) ||
          b.author.toLowerCase().includes(detailSearchQuery.toLowerCase())
      )
    : [];

  return (
    <div style={{
      minHeight: "100vh",
      background: "#FDFAF6",
      fontFamily: "'DM Sans', sans-serif",
      color: "#1A1A1A",
      position: "relative",
      overflow: "hidden",
    }}>
      <style>{fonts}</style>
      <style>{`
        * { box-sizing: border-box; margin: 0; padding: 0; }
        ::selection { background: #E8D5C4; }
        input:focus { outline: none; }
        .fade-enter { opacity: 0; transform: translateY(12px); }
        .fade-active { opacity: 1; transform: translateY(0); transition: opacity 0.5s ease, transform 0.5s ease; }
        .suggestion-item:hover { background: #F5EDE4 !important; }
        .send-btn:hover { background: #1A1A1A !important; color: #FDFAF6 !important; }
        .back-btn:hover { opacity: 0.7; }
        @keyframes pulse { 0%, 100% { opacity: 0.4; } 50% { opacity: 1; } }
        @keyframes fadeUp { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        .typing-dot { animation: blink 1.4s infinite; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        textarea { font-family: 'DM Sans', sans-serif; resize: none; }
        textarea:focus { outline: none; }
        .source-tag:hover { background: #E8D5C4 !important; }

        /* Scrollbar */
        .chat-scroll::-webkit-scrollbar { width: 4px; }
        .chat-scroll::-webkit-scrollbar-track { background: transparent; }
        .chat-scroll::-webkit-scrollbar-thumb { background: #D4C4B0; border-radius: 2px; }
      `}</style>

      {/* ====== SCREEN: HOME ====== */}
      {screen === "home" && (
        <div
          className={fadeIn ? "fade-active" : "fade-enter"}
          style={{
            minHeight: "100vh",
            display: "flex",
            flexDirection: "column",
            alignItems: "center",
            justifyContent: "center",
            padding: "40px 24px",
            position: "relative",
          }}
        >
          {/* Subtle grain texture */}
          <div style={{
            position: "absolute", inset: 0,
            backgroundImage: "url(\"data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.03'/%3E%3C/svg%3E\")",
            pointerEvents: "none",
          }} />

          {/* Logo */}
          <div style={{
            fontFamily: "'Instrument Serif', serif",
            fontSize: 18,
            letterSpacing: "0.12em",
            color: "#8B7355",
            marginBottom: 80,
            textTransform: "uppercase",
          }}>
            Afterword
          </div>

          {/* Tagline */}
          <h1 style={{
            fontFamily: "'Instrument Serif', serif",
            fontSize: "clamp(32px, 5vw, 56px)",
            fontWeight: 400,
            textAlign: "center",
            lineHeight: 1.15,
            maxWidth: 600,
            marginBottom: 48,
            color: "#1A1A1A",
          }}>
            Discuss any book like you<br />
            <em style={{ fontStyle: "italic" }}>read it together.</em>
          </h1>

          {/* Search */}
          <div style={{ position: "relative", width: "100%", maxWidth: 520 }}>
            <div style={{
              display: "flex",
              alignItems: "center",
              background: "#FFFFFF",
              border: "1px solid #E0D6CA",
              borderRadius: 12,
              padding: "16px 20px",
              boxShadow: "0 2px 12px rgba(139, 115, 85, 0.06)",
              transition: "box-shadow 0.2s, border-color 0.2s",
              ...(showSuggestions && filteredBooks.length > 0
                ? { borderBottomLeftRadius: 0, borderBottomRightRadius: 0, borderColor: "#C4B49A" }
                : {}),
            }}>
              {/* Search icon */}
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#8B7355" strokeWidth="2" strokeLinecap="round" style={{ marginRight: 12, flexShrink: 0 }}>
                <circle cx="11" cy="11" r="8" />
                <line x1="21" y1="21" x2="16.65" y2="16.65" />
              </svg>
              <input
                type="text"
                placeholder="Search by title or author..."
                value={searchQuery}
                onChange={(e) => {
                  setSearchQuery(e.target.value);
                  setShowSuggestions(true);
                }}
                onFocus={() => setShowSuggestions(true)}
                style={{
                  flex: 1,
                  border: "none",
                  background: "none",
                  fontSize: 16,
                  fontFamily: "'DM Sans', sans-serif",
                  color: "#1A1A1A",
                  letterSpacing: "-0.01em",
                }}
              />
            </div>

            {/* Suggestions dropdown */}
            {showSuggestions && filteredBooks.length > 0 && (
              <div style={{
                position: "absolute",
                top: "100%",
                left: 0,
                right: 0,
                background: "#FFFFFF",
                border: "1px solid #C4B49A",
                borderTop: "1px solid #EDE6DB",
                borderBottomLeftRadius: 12,
                borderBottomRightRadius: 12,
                overflow: "hidden",
                boxShadow: "0 8px 24px rgba(139, 115, 85, 0.1)",
                zIndex: 10,
              }}>
                {filteredBooks.map((book) => (
                  <div
                    key={book.id}
                    className="suggestion-item"
                    onClick={handleSelectBook}
                    style={{
                      padding: "14px 20px",
                      cursor: "pointer",
                      display: "flex",
                      justifyContent: "space-between",
                      alignItems: "baseline",
                      transition: "background 0.15s",
                    }}
                  >
                    <div>
                      <span style={{ fontWeight: 500, fontSize: 15 }}>{book.title}</span>
                      <span style={{ color: "#8B7355", fontSize: 14, marginLeft: 8 }}>{book.author}</span>
                    </div>
                    <span style={{ color: "#B0A08A", fontSize: 13 }}>{book.year}</span>
                  </div>
                ))}
              </div>
            )}
          </div>

          {/* Curated suggestions */}
          <div style={{
            marginTop: 48,
            display: "flex",
            gap: 8,
            flexWrap: "wrap",
            justifyContent: "center",
            maxWidth: 520,
          }}>
            {["Never Let Me Go", "Educated", "Project Hail Mary"].map((title) => (
              <button
                key={title}
                onClick={() => {
                  setSearchQuery(title);
                  setShowSuggestions(true);
                }}
                style={{
                  background: "none",
                  border: "1px solid #E0D6CA",
                  borderRadius: 20,
                  padding: "8px 16px",
                  fontSize: 13,
                  color: "#8B7355",
                  cursor: "pointer",
                  fontFamily: "'DM Sans', sans-serif",
                  transition: "all 0.15s",
                }}
                onMouseEnter={(e) => {
                  e.target.style.background = "#F5EDE4";
                  e.target.style.borderColor = "#C4B49A";
                }}
                onMouseLeave={(e) => {
                  e.target.style.background = "none";
                  e.target.style.borderColor = "#E0D6CA";
                }}
              >
                {title}
              </button>
            ))}
          </div>

          {/* Footer */}
          <div style={{
            position: "absolute",
            bottom: 32,
            fontSize: 12,
            color: "#B0A08A",
            letterSpacing: "0.04em",
          }}>
            An Aurora Labs experiment
          </div>
        </div>
      )}

      {/* ====== SCREEN: LOADING ====== */}
      {screen === "loading" && (
        <div
          className={fadeIn ? "fade-active" : "fade-enter"}
          style={{
            minHeight: "100vh",
            display: "flex",
            flexDirection: "column",
            alignItems: "center",
            justifyContent: "center",
            padding: "40px 24px",
            background: "#1A1A1A",
            color: "#FDFAF6",
          }}
        >
          {/* Book cover placeholder */}
          <div style={{
            width: 140,
            height: 210,
            borderRadius: 4,
            background: "linear-gradient(145deg, #3D3428 0%, #2A2318 100%)",
            border: "1px solid #4A3F32",
            display: "flex",
            flexDirection: "column",
            alignItems: "center",
            justifyContent: "center",
            padding: 20,
            marginBottom: 32,
            boxShadow: "0 8px 32px rgba(0,0,0,0.4)",
          }}>
            <div style={{
              fontFamily: "'Instrument Serif', serif",
              fontSize: 16,
              textAlign: "center",
              lineHeight: 1.3,
              color: "#E8D5C4",
            }}>
              Never Let<br />Me Go
            </div>
            <div style={{
              fontSize: 11,
              color: "#8B7355",
              marginTop: 12,
              letterSpacing: "0.05em",
            }}>
              ISHIGURO
            </div>
          </div>

          <h2 style={{
            fontFamily: "'Instrument Serif', serif",
            fontSize: 24,
            fontWeight: 400,
            marginBottom: 4,
          }}>
            Never Let Me Go
          </h2>
          <div style={{ fontSize: 14, color: "#8B7355", marginBottom: 40 }}>
            Kazuo Ishiguro · 2005
          </div>

          {/* Loading steps */}
          <div style={{ width: "100%", maxWidth: 360, marginBottom: 48 }}>
            {LOADING_STEPS.map((step, i) => {
              const isDone = i < loadingStep || loadingComplete;
              const isCurrent = i === loadingStep && !loadingComplete;
              return (
                <div
                  key={i}
                  style={{
                    display: "flex",
                    alignItems: "center",
                    gap: 12,
                    padding: "10px 0",
                    opacity: isDone ? 1 : isCurrent ? 0.9 : 0.3,
                    transition: "opacity 0.4s ease",
                  }}
                >
                  <div style={{
                    width: 20,
                    height: 20,
                    borderRadius: "50%",
                    border: `1.5px solid ${isDone ? "#8B7355" : isCurrent ? "#8B7355" : "#4A3F32"}`,
                    display: "flex",
                    alignItems: "center",
                    justifyContent: "center",
                    flexShrink: 0,
                    transition: "all 0.3s",
                  }}>
                    {isDone && (
                      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#8B7355" strokeWidth="2.5" strokeLinecap="round">
                        <polyline points="20 6 9 17 4 12" />
                      </svg>
                    )}
                    {isCurrent && (
                      <div style={{
                        width: 6,
                        height: 6,
                        borderRadius: "50%",
                        background: "#8B7355",
                        animation: "pulse 1.5s infinite",
                      }} />
                    )}
                  </div>
                  <span style={{
                    fontSize: 14,
                    color: isDone ? "#E8D5C4" : isCurrent ? "#C4B49A" : "#4A3F32",
                    transition: "color 0.4s",
                  }}>
                    {step.label}{isDone ? " ✓" : isCurrent ? "..." : ""}
                  </span>
                </div>
              );
            })}
          </div>

          {/* Ambient quote */}
          <div style={{
            maxWidth: 440,
            textAlign: "center",
            animation: "fadeUp 1s ease 0.5s both",
          }}>
            <p style={{
              fontFamily: "'Instrument Serif', serif",
              fontSize: 16,
              fontStyle: "italic",
              lineHeight: 1.6,
              color: "#8B7355",
              marginBottom: 8,
            }}>
              {AMBIENT_QUOTE}
            </p>
            <p style={{ fontSize: 12, color: "#5A4F40" }}>
              {AMBIENT_QUOTE_SOURCE}
            </p>
          </div>
        </div>
      )}

      {/* ====== SCREEN: BOOK DETAIL ====== */}
      {screen === "detail" && (
        <div
          className={fadeIn ? "fade-active" : "fade-enter"}
          style={{
            minHeight: "100vh",
            display: "flex",
            flexDirection: "column",
          }}
        >
          {/* Top bar */}
          <div style={{
            padding: "12px 24px",
            display: "flex",
            alignItems: "center",
            gap: 16,
            borderBottom: "1px solid #EDE6DB",
            background: "#FDFAF6",
            position: "sticky",
            top: 0,
            zIndex: 10,
          }}>
            {/* Logo - clickable back to home */}
            <button
              className="back-btn"
              onClick={() => {
                setScreen("home");
                setSearchQuery("");
                setDetailSearchQuery("");
                setShowDetailSuggestions(false);
                setMessages(MOCK_MESSAGES);
                setUserHasSent(false);
              }}
              style={{
                background: "none",
                border: "none",
                cursor: "pointer",
                fontFamily: "'Instrument Serif', serif",
                fontSize: 15,
                letterSpacing: "0.1em",
                color: "#8B7355",
                textTransform: "uppercase",
                whiteSpace: "nowrap",
                transition: "opacity 0.15s",
                padding: 0,
              }}
            >
              Afterword
            </button>

            {/* Search bar */}
            <div style={{ position: "relative", flex: 1, maxWidth: 360 }}>
              <div style={{
                display: "flex",
                alignItems: "center",
                background: "#F5F0E8",
                border: "1px solid #E8DFD0",
                borderRadius: 8,
                padding: "8px 12px",
                transition: "border-color 0.2s",
                ...(showDetailSuggestions && detailFilteredBooks.length > 0
                  ? { borderBottomLeftRadius: 0, borderBottomRightRadius: 0, borderColor: "#C4B49A" }
                  : {}),
              }}>
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#B0A08A" strokeWidth="2" strokeLinecap="round" style={{ marginRight: 8, flexShrink: 0 }}>
                  <circle cx="11" cy="11" r="8" />
                  <line x1="21" y1="21" x2="16.65" y2="16.65" />
                </svg>
                <input
                  type="text"
                  placeholder="Search another book..."
                  value={detailSearchQuery}
                  onChange={(e) => {
                    setDetailSearchQuery(e.target.value);
                    setShowDetailSuggestions(true);
                  }}
                  onFocus={() => setShowDetailSuggestions(true)}
                  onBlur={() => setTimeout(() => setShowDetailSuggestions(false), 200)}
                  style={{
                    flex: 1,
                    border: "none",
                    background: "none",
                    fontSize: 13,
                    fontFamily: "'DM Sans', sans-serif",
                    color: "#1A1A1A",
                  }}
                />
              </div>

              {/* Dropdown */}
              {showDetailSuggestions && detailFilteredBooks.length > 0 && (
                <div style={{
                  position: "absolute",
                  top: "100%",
                  left: 0,
                  right: 0,
                  background: "#FFFFFF",
                  border: "1px solid #C4B49A",
                  borderTop: "1px solid #EDE6DB",
                  borderBottomLeftRadius: 8,
                  borderBottomRightRadius: 8,
                  overflow: "hidden",
                  boxShadow: "0 8px 24px rgba(139, 115, 85, 0.12)",
                  zIndex: 20,
                }}>
                  {detailFilteredBooks.map((book) => (
                    <div
                      key={book.id}
                      className="suggestion-item"
                      onClick={() => {
                        setDetailSearchQuery("");
                        setShowDetailSuggestions(false);
                        setMessages(MOCK_MESSAGES);
                        setUserHasSent(false);
                        setScreen("loading");
                      }}
                      style={{
                        padding: "10px 14px",
                        cursor: "pointer",
                        display: "flex",
                        justifyContent: "space-between",
                        alignItems: "baseline",
                        transition: "background 0.15s",
                        fontSize: 13,
                      }}
                    >
                      <div>
                        <span style={{ fontWeight: 500 }}>{book.title}</span>
                        <span style={{ color: "#8B7355", fontSize: 12, marginLeft: 6 }}>{book.author}</span>
                      </div>
                      <span style={{ color: "#B0A08A", fontSize: 12 }}>{book.year}</span>
                    </div>
                  ))}
                </div>
              )}
            </div>
          </div>

          {/* Main content area */}
          <div style={{
            flex: 1,
            display: "flex",
            flexDirection: "column",
            maxWidth: 720,
            width: "100%",
            margin: "0 auto",
            padding: "0 24px",
          }}>
            {/* Book metadata section */}
            <div style={{
              padding: "32px 0 28px",
            }}>
              <div style={{ display: "flex", gap: 24 }}>
                {/* Cover */}
                <div style={{
                  width: 110,
                  height: 165,
                  borderRadius: 4,
                  background: "linear-gradient(145deg, #3D3428 0%, #2A2318 100%)",
                  border: "1px solid #E0D6CA",
                  display: "flex",
                  flexDirection: "column",
                  alignItems: "center",
                  justifyContent: "center",
                  padding: 14,
                  flexShrink: 0,
                  boxShadow: "0 4px 16px rgba(0,0,0,0.08)",
                }}>
                  <div style={{
                    fontFamily: "'Instrument Serif', serif",
                    fontSize: 13,
                    textAlign: "center",
                    lineHeight: 1.3,
                    color: "#E8D5C4",
                  }}>
                    Never Let<br />Me Go
                  </div>
                  <div style={{ fontSize: 9, color: "#8B7355", marginTop: 8, letterSpacing: "0.05em" }}>
                    ISHIGURO
                  </div>
                </div>

                {/* Details */}
                <div style={{ flex: 1 }}>
                  {/* Title + Year */}
                  <div style={{ display: "flex", alignItems: "baseline", gap: 10, marginBottom: 8 }}>
                    <h1 style={{
                      fontFamily: "'Instrument Serif', serif",
                      fontSize: 28,
                      fontWeight: 400,
                      lineHeight: 1.2,
                    }}>
                      Never Let Me Go
                    </h1>
                    <span style={{
                      fontSize: 14,
                      color: "#B0A08A",
                      fontFamily: "'JetBrains Mono', monospace",
                      flexShrink: 0,
                    }}>
                      2005
                    </span>
                  </div>

                  {/* Author */}
                  <div style={{
                    fontSize: 15,
                    color: "#6B5D4D",
                    marginBottom: 12,
                    display: "flex",
                    alignItems: "center",
                    gap: 8,
                  }}>
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#B0A08A" strokeWidth="2" strokeLinecap="round">
                      <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
                      <circle cx="12" cy="7" r="4" />
                    </svg>
                    <span>Kazuo Ishiguro</span>
                  </div>

                  {/* Genre tag */}
                  <div style={{
                    display: "flex",
                    alignItems: "center",
                    gap: 10,
                    marginBottom: 14,
                  }}>
                    <span style={{
                      fontSize: 12,
                      color: "#8B7355",
                      background: "#F5EDE4",
                      padding: "4px 12px",
                      borderRadius: 20,
                      fontWeight: 500,
                      letterSpacing: "0.02em",
                    }}>
                      Literary Fiction
                    </span>
                    {/* Rating */}
                    <div style={{
                      display: "flex",
                      alignItems: "center",
                      gap: 5,
                      fontSize: 13,
                    }}>
                      <span style={{ color: "#C4974A" }}>★</span>
                      <span style={{ fontWeight: 500, color: "#6B5D4D" }}>3.83</span>
                      <span style={{ color: "#B0A08A", fontSize: 12 }}>/ 5</span>
                    </div>
                  </div>

                  {/* Synopsis */}
                  <p style={{
                    fontSize: 14,
                    lineHeight: 1.65,
                    color: "#5A4F40",
                    marginBottom: 10,
                  }}>
                    {BOOK_DETAIL.synopsis}
                  </p>

                  {/* Page count + ratings - subtle footer */}
                  <div style={{
                    display: "flex",
                    alignItems: "center",
                    gap: 16,
                    fontSize: 12,
                    color: "#B0A08A",
                  }}>
                    <span style={{ display: "flex", alignItems: "center", gap: 5 }}>
                      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round">
                        <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20" />
                        <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z" />
                      </svg>
                      288 pages
                    </span>
                    <span>542,891 ratings</span>
                  </div>
                </div>
              </div>
            </div>

            {/* How This Book Is Read — distinct background */}
            <div style={{
              padding: "24px",
              margin: "0 -24px",
              background: "#F5F0E8",
              borderTop: "1px solid #E8DFD0",
              borderBottom: "1px solid #E8DFD0",
            }}>
              <h2 style={{
                fontFamily: "'Instrument Serif', serif",
                fontSize: 13,
                fontWeight: 400,
                letterSpacing: "0.14em",
                textTransform: "uppercase",
                color: "#8B7355",
                marginBottom: 20,
              }}>
                How This Book Is Read
              </h2>

              <div style={{ display: "flex", flexDirection: "column", gap: 18 }}>
                {[
                  {
                    label: "Critics",
                    text: BOOK_DETAIL.critics,
                    color: "#8B7355",
                    bgColor: "#EDE4D6",
                    icon: (
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                        <polyline points="14 2 14 8 20 8" />
                        <line x1="16" y1="13" x2="8" y2="13" />
                        <line x1="16" y1="17" x2="8" y2="17" />
                      </svg>
                    ),
                  },
                  {
                    label: "Readers",
                    text: BOOK_DETAIL.readers,
                    color: "#6B8B73",
                    bgColor: "#DDE8DF",
                    icon: (
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
                        <circle cx="9" cy="7" r="4" />
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87" />
                        <path d="M16 3.13a4 4 0 0 1 0 7.75" />
                      </svg>
                    ),
                  },
                  {
                    label: "The debate",
                    text: BOOK_DETAIL.debate,
                    color: "#7B6B8B",
                    bgColor: "#E4DDE8",
                    icon: (
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />
                      </svg>
                    ),
                  },
                ].map(({ label, text, color, bgColor, icon }) => (
                  <div key={label} style={{
                    display: "flex",
                    gap: 14,
                    alignItems: "flex-start",
                    background: "#FDFAF6",
                    borderRadius: 10,
                    padding: "14px 16px",
                    border: "1px solid #E8DFD0",
                  }}>
                    <div style={{
                      width: 32,
                      height: 32,
                      borderRadius: 8,
                      background: bgColor,
                      display: "flex",
                      alignItems: "center",
                      justifyContent: "center",
                      flexShrink: 0,
                      color: color,
                    }}>
                      {icon}
                    </div>
                    <div style={{ flex: 1 }}>
                      <div style={{
                        fontSize: 12,
                        fontWeight: 600,
                        color: color,
                        letterSpacing: "0.04em",
                        textTransform: "uppercase",
                        marginBottom: 4,
                      }}>
                        {label}
                      </div>
                      <p style={{
                        fontSize: 14,
                        lineHeight: 1.6,
                        color: "#3D3428",
                      }}>
                        {text}
                      </p>
                    </div>
                  </div>
                ))}
              </div>
            </div>

            {/* Sources bar */}
            <div style={{
              padding: "16px 0",
              display: "flex",
              alignItems: "center",
              gap: 8,
              flexWrap: "wrap",
              borderBottom: "1px solid #EDE6DB",
            }}>
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#B0A08A" strokeWidth="2" strokeLinecap="round" style={{ marginRight: 2 }}>
                <circle cx="12" cy="12" r="10" />
                <line x1="12" y1="16" x2="12" y2="12" />
                <line x1="12" y1="8" x2="12.01" y2="8" />
              </svg>
              <span style={{ fontSize: 12, color: "#B0A08A", marginRight: 4 }}>Sources ingested:</span>
              {[
                { name: "Goodreads", icon: "★" },
                { name: "Reddit", icon: "◉" },
                { name: "The Guardian", icon: "▤" },
                { name: "Paris Review", icon: "◈" },
                { name: "LitHub", icon: "▣" },
              ].map((s) => (
                <span
                  key={s.name}
                  className="source-tag"
                  style={{
                    fontSize: 11,
                    color: "#6B5D4D",
                    background: "#F5EDE4",
                    padding: "4px 10px",
                    borderRadius: 12,
                    cursor: "default",
                    transition: "background 0.15s",
                    display: "flex",
                    alignItems: "center",
                    gap: 4,
                  }}
                >
                  <span style={{ fontSize: 10, opacity: 0.6 }}>{s.icon}</span>
                  {s.name}
                </span>
              ))}
            </div>

            {/* Chat section */}
            <div style={{
              flex: 1,
              display: "flex",
              flexDirection: "column",
              paddingTop: 24,
              paddingBottom: 24,
              minHeight: 400,
            }}>
              {/* Messages area */}
              <div
                className="chat-scroll"
                style={{
                  flex: 1,
                  overflowY: "auto",
                  display: "flex",
                  flexDirection: "column",
                  gap: 24,
                  paddingBottom: 16,
                  maxHeight: 520,
                }}
              >
                {/* Opening state — before any messages */}
                {messages.length === 0 && !isTyping && (
                  <div style={{ animation: "fadeUp 0.5s ease both" }}>
                    {/* Header */}
                    <div style={{
                      display: "flex",
                      alignItems: "center",
                      gap: 10,
                      marginBottom: 12,
                    }}>
                      <div style={{
                        width: 32,
                        height: 32,
                        borderRadius: "50%",
                        background: "#2A2318",
                        border: "1px solid #4A3F32",
                        display: "flex",
                        alignItems: "center",
                        justifyContent: "center",
                      }}>
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#C4B49A" strokeWidth="2" strokeLinecap="round">
                          <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" />
                        </svg>
                      </div>
                      <span style={{
                        fontFamily: "'Instrument Serif', serif",
                        fontSize: 20,
                        color: "#1A1A1A",
                      }}>
                        Discuss <em>Never Let Me Go</em>
                      </span>
                    </div>

                    {/* Subtitle */}
                    <p style={{
                      fontSize: 15,
                      color: "#8B7355",
                      lineHeight: 1.5,
                      marginBottom: 24,
                    }}>
                      The companion has read 1,847 reviews, threads, and essays. Ask it anything.
                    </p>

                    {/* Question prompt grid */}
                    <div style={{
                      display: "grid",
                      gridTemplateColumns: "1fr 1fr",
                      gap: 10,
                      marginBottom: 8,
                    }}>
                      {QUESTION_PROMPTS.map((q, i) => (
                        <button
                          key={i}
                          onClick={() => {
                            setInputValue(q);
                            // Auto-send after a brief moment
                            setTimeout(() => {
                              const userMsg = { role: "user", content: q, sources: [] };
                              setMessages((prev) => [...prev, userMsg]);
                              setInputValue("");
                              setUserHasSent(true);
                              setIsTyping(true);
                              setTimeout(() => {
                                setIsTyping(false);
                                setMessages((prev) => [
                                  ...prev,
                                  { role: "assistant", content: COMPANION_RESPONSE.content, sources: COMPANION_RESPONSE.sources },
                                ]);
                              }, 2800);
                            }, 150);
                          }}
                          style={{
                            background: "transparent",
                            border: "1px solid #D4C4B0",
                            borderRadius: 12,
                            padding: "16px 18px",
                            fontSize: 14,
                            fontFamily: "'DM Sans', sans-serif",
                            color: "#3D3428",
                            textAlign: "left",
                            cursor: "pointer",
                            lineHeight: 1.45,
                            transition: "all 0.2s ease",
                            gridColumn: i === QUESTION_PROMPTS.length - 1 && QUESTION_PROMPTS.length % 2 !== 0 ? "1 / -1" : "auto",
                          }}
                          onMouseEnter={(e) => {
                            e.currentTarget.style.background = "#F5EDE4";
                            e.currentTarget.style.borderColor = "#B0A08A";
                          }}
                          onMouseLeave={(e) => {
                            e.currentTarget.style.background = "transparent";
                            e.currentTarget.style.borderColor = "#D4C4B0";
                          }}
                        >
                          {q}
                        </button>
                      ))}
                    </div>
                  </div>
                )}

                {/* Chat messages */}
                {messages.map((msg, i) => (
                  <div
                    key={i}
                    style={{
                      animation: "fadeUp 0.4s ease both",
                      maxWidth: msg.role === "user" ? "85%" : "100%",
                      alignSelf: msg.role === "user" ? "flex-end" : "flex-start",
                    }}
                  >
                    {msg.role === "assistant" && (
                      <div style={{
                        fontSize: 11,
                        color: "#B0A08A",
                        marginBottom: 6,
                        letterSpacing: "0.04em",
                        textTransform: "uppercase",
                      }}>
                        Companion
                      </div>
                    )}
                    <div style={{
                      background: msg.role === "user" ? "#1A1A1A" : "transparent",
                      color: msg.role === "user" ? "#FDFAF6" : "#1A1A1A",
                      borderRadius: msg.role === "user" ? 16 : 0,
                      padding: msg.role === "user" ? "12px 18px" : "0",
                      fontSize: 15,
                      fontFamily: "'DM Sans', sans-serif",
                      lineHeight: 1.65,
                      whiteSpace: "pre-line",
                    }}>
                      {msg.content}
                    </div>
                    {/* Source attribution for assistant messages */}
                    {msg.role === "assistant" && msg.sources && msg.sources.length > 0 && (
                      <div style={{
                        display: "flex",
                        gap: 6,
                        marginTop: 10,
                        flexWrap: "wrap",
                      }}>
                        <span style={{ fontSize: 11, color: "#C4B49A", lineHeight: "22px" }}>Drew from:</span>
                        {msg.sources.map((s) => (
                          <span key={s} style={{
                            fontSize: 11,
                            color: "#8B7355",
                            background: "#F5EDE4",
                            padding: "2px 8px",
                            borderRadius: 8,
                          }}>
                            {s}
                          </span>
                        ))}
                      </div>
                    )}
                  </div>
                ))}

                {/* Typing indicator */}
                {isTyping && (
                  <div style={{ animation: "fadeUp 0.3s ease both" }}>
                    <div style={{
                      fontSize: 11,
                      color: "#B0A08A",
                      marginBottom: 6,
                      letterSpacing: "0.04em",
                      textTransform: "uppercase",
                    }}>
                      Companion
                    </div>
                    <div style={{ display: "flex", gap: 4 }}>
                      {[0, 1, 2].map((i) => (
                        <div
                          key={i}
                          className="typing-dot"
                          style={{
                            width: 6,
                            height: 6,
                            borderRadius: "50%",
                            background: "#C4B49A",
                          }}
                        />
                      ))}
                    </div>
                  </div>
                )}
                <div ref={chatEndRef} />
              </div>

              {/* Input area */}
              <div style={{
                borderTop: "1px solid #EDE6DB",
                paddingTop: 16,
                marginTop: 8,
              }}>
                <div style={{
                  display: "flex",
                  gap: 10,
                  alignItems: "flex-end",
                }}>
                  <textarea
                    value={inputValue}
                    onChange={(e) => setInputValue(e.target.value)}
                    onKeyDown={(e) => {
                      if (e.key === "Enter" && !e.shiftKey) {
                        e.preventDefault();
                        handleSendMessage();
                      }
                    }}
                    placeholder={userHasSent ? "Continue the conversation..." : "Ask about Never Let Me Go..."}
                    rows={1}
                    style={{
                      flex: 1,
                      background: "#FFFFFF",
                      border: "1px solid #E0D6CA",
                      borderRadius: 12,
                      padding: "12px 16px",
                      fontSize: 15,
                      lineHeight: 1.5,
                      color: "#1A1A1A",
                      minHeight: 46,
                      maxHeight: 120,
                    }}
                    onInput={(e) => {
                      e.target.style.height = "auto";
                      e.target.style.height = Math.min(e.target.scrollHeight, 120) + "px";
                    }}
                  />
                  <button
                    className="send-btn"
                    onClick={handleSendMessage}
                    disabled={!inputValue.trim()}
                    style={{
                      background: inputValue.trim() ? "#1A1A1A" : "#E0D6CA",
                      color: inputValue.trim() ? "#FDFAF6" : "#B0A08A",
                      border: "none",
                      borderRadius: 12,
                      width: 46,
                      height: 46,
                      display: "flex",
                      alignItems: "center",
                      justifyContent: "center",
                      cursor: inputValue.trim() ? "pointer" : "default",
                      transition: "all 0.2s",
                      flexShrink: 0,
                    }}
                  >
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round">
                      <line x1="22" y1="2" x2="11" y2="13" />
                      <polygon points="22 2 15 22 11 13 2 9 22 2" />
                    </svg>
                  </button>
                </div>
                <div style={{
                  fontSize: 11,
                  color: "#C4B49A",
                  marginTop: 8,
                  textAlign: "center",
                }}>
                  Powered by Claude · Sources verified against published reviews and criticism
                </div>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}